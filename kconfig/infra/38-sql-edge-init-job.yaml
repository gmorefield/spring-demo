apiVersion: batch/v1
kind: Job
metadata:
  name: sqledge-init-job
  namespace: spring-demo
spec:
  parallelism: 1    
  completions: 1    
  template:         
    metadata:
      name: sqledge-init-job
      namespace: spring-demo
    spec:
      containers:
      - name: sqledge-init-job
        image: mcr.microsoft.com/mssql-tools:latest
        env:
          - name: SQLCMDPASSWORD
            valueFrom:
              secretKeyRef:
                name: datasource
                key: password
        command:
        - /bin/sh
        - -c
        - |
          sleep_time=20
          sleep $sleep_time
          
          for i in $(seq 1 10); do
            /opt/mssql-tools/bin/sqlcmd -S sqledge -U sa -C -Q "create database SpringDemo"
            rc=$?
            if [ $rc -eq 0 ]; then
              echo "SpringDemo db created"
              /opt/mssql-tools/bin/sqlcmd -S sqledge -U sa -d SpringDemo -C -Q "create schema Test"
              echo "Create schema Test finished with rc=$?"
              break
            else
              echo "Create SpringDemo failed with exit code $?. Retrying in $sleep_time seconds..."
              sleep $sleep_time
            fi
          done
      restartPolicy: Never